<% title "Alert Summary" %>

<table class='list'>
  <tr>
    <th colspan=4>By Alert Type</th>
  </tr>
  <tr>
    <th>Alert Type</th>
    <th>Count</th>
    <th>Latest received</th>
    <th>Latest sent</th>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Total</strong></td>
    <td class='right-justify'><%= number_with_delimiter(@num_alerts) -%></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Total Devices</strong></td>
    <td class='right-justify'><%= number_with_delimiter(@num_devices) -%></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Call for Service</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_service), "/alerts?msg_q=service&commit=Find" -%></td>
    <td>
      <% unless @last_service.nil? %>
      <%= @last_service.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_service.device.name, "/alerts?model_q=#{@last_service.device.model}&serial_q=#{@last_service.device.serial}&msg_q=call for service&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @service_sent.nil? or @service_sent.service_sent.nil? %>
      <%= @service_sent.service_sent.to_formatted_s(:db) -%> for <%= link_to @service_sent.device.name, "/alerts?model_q=#{@service_sent.device.model}&serial_q=#{@service_sent.device.serial}&msg_q=call for service&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Maintenance Required</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_pm), "/alerts?msg_q=maintenance&commit=Find" -%></td>
    <td>
      <% unless @last_pm.nil? %>
      <%= @last_pm.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_pm.device.name, "/alerts?model_q=#{@last_pm.device.model}&serial_q=#{@last_pm.device.serial}&msg_q=Maintenance&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @pm_sent.nil? or @pm_sent.pm_sent.nil? %>
      <%= @pm_sent.pm_sent.to_formatted_s(:db) -%> for <%= link_to @pm_sent.device.name, "/alerts?model_q=#{@pm_sent.device.model}&serial_q=#{@pm_sent.device.serial}&msg_q=Maintenance&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Misfeed</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_misfeed), "/alerts?msg_q=misfeed&commit=Find" -%></td>
    <td>
      <% unless @last_misfeed.nil? %>
      <%= @last_misfeed.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_misfeed.device.name, "/alerts?model_q=#{@last_misfeed.device.model}&serial_q=#{@last_misfeed.device.serial}&msg_q=Misfeed&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @misfeed_sent.nil? or @misfeed_sent.jam_sent.nil? %>
      <%= @misfeed_sent.jam_sent.to_formatted_s(:db) -%> for <%= link_to @misfeed_sent.device.name, "/alerts?model_q=#{@misfeed_sent.device.model}&serial_q=#{@misfeed_sent.device.serial}&msg_q=Misfeed&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Out of Paper</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_paper), "/alerts?msg_q=Load paper&commit=Find" -%></td>
    <td>
      <% unless @last_paper.nil? %>
      <%= @last_paper.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_paper.device.name, "/alerts?model_q=#{@last_paper.device.model}&serial_q=#{@last_paper.device.serial}&msg_q=Load paper&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @paper_sent.nil? or @paper_sent.paper_sent.nil? %>
      <%= @paper_sent.paper_sent.to_formatted_s(:db) -%> for <%= link_to @paper_sent.device.name, "/alerts?model_q=#{@paper_sent.device.model}&serial_q=#{@paper_sent.device.serial}&msg_q=Load paper&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Toner Low</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_toner_low), "/alerts?msg_q=Toner supply&commit=Find" -%></td>
    <td>
      <% unless @last_toner_low.nil? %>
      <%= @last_toner_low.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_toner_low.device.name, "/alerts?model_q=#{@last_toner_low.device.model}&serial_q=#{@last_toner_low.device.serial}&msg_q=Toner supply&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @toner_low_sent.nil? or @toner_low_sent.toner_low_sent.nil? %>
      <%= @toner_low_sent.toner_low_sent.to_formatted_s(:db) -%> for <%= link_to @toner_low_sent.device.name, "/alerts?model_q=#{@toner_low_sent.device.model}&serial_q=#{@toner_low_sent.device.serial}&msg_q=Toner supply&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Out of Toner</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_toner_out), "/alerts?msg_q=Add toner&commit=Find" -%></td>
    <td>
      <% unless @last_toner_out.nil? %>
      <%= @last_toner_out.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_toner_out.device.name, "/alerts?model_q=#{@last_toner_out.device.model}&serial_q=#{@last_toner_out.device.serial}&msg_q=Add toner&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @toner_out_sent.nil? or @toner_out_sent.toner_empty_sent.nil? %>
      <%= @toner_out_sent.toner_empty_sent.to_formatted_s(:db) -%> for <%= link_to @toner_out_sent.device.name, "/alerts?model_q=#{@toner_out_sent.device.model}&serial_q=#{@toner_out_sent.device.serial}&msg_q=Add toner&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Waste Toner Container Warnings</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_waste_warn), "/alerts?msg_q=Replacement&commit=Find" -%></td>
    <td>
      <% unless @last_waste_warn.nil? %>
      <%= @last_waste_warn.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_waste_warn.device.name, "/alerts?model_q=#{@last_waste_warn.device.model}&serial_q=#{@last_waste_warn.device.serial}&msg_q=Replacement&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @waste_warn_sent.nil? or @waste_warn_sent.waste_almost_full_sent.nil? %>
      <%= @waste_warn_sent.waste_almost_full_sent.to_formatted_s(:db) -%> for <%= link_to @waste_warn_sent.device.name, "/alerts?model_q=#{@waste_warn_sent.device.model}&serial_q=#{@waste_warn_sent.device.serial}&msg_q=Replacement&commit=Find" -%>
      <% end %>
    </td>
  </tr>
  <tr class="<%= cycle('light','dark') -%>">
    <td><strong>Waste Toner Container Full</strong></td>
    <td class='right-justify'><%= link_to number_with_delimiter(@num_waste_full), "/alerts?msg_q=Replace Used Toner&commit=Find" -%></td>
    <td>
      <% unless @last_waste_full.nil? %>
      <%= @last_waste_full.alert_date.to_formatted_s(:db) -%> from <%= link_to @last_waste_full.device.name, "/alerts?model_q=#{@last_waste_full.device.model}&serial_q=#{@last_waste_full.device.serial}&msg_q=Replace used toner&commit=Find" -%>
      <% end %>
    </td>
    <td>
      <% unless @waste_full_sent.nil? or @waste_full_sent.waste_full_sent.nil? %>
      <%= @waste_full_sent.waste_full_sent.to_formatted_s(:db) -%> for <%= link_to @waste_full_sent.device.name, "/alerts?model_q=#{@waste_full_sent.device.model}&serial_q=#{@waste_full_sent.device.serial}&msg_q=Replace used toner&commit=Find" -%>
      <% end %>
    </td>
  </tr>
</table>
<br />

<%= form_tag "/summaries", :method => 'get' do %>
  <%= label_tag 'client', "Select client to show device and model summaries for (WARNING: Selecting 'All' may take a while): " %>
  <%= collection_select :client, :client_id, Client.all, :id, :name, :include_blank => 'All' %>
  <%= submit_tag "Show" %>
<% end %>

<% unless @devices_by_name.nil? %>

<table class="list">
  <tr>
    <th colspan=10>Alerts by Device - Number in parenthesis is number of alerts per day on average</th>
  </tr>
  <tr>
    <th>Device</th>
    <th>Monitored for</th>
    <th>Misfeed</th>
    <th>Paper Out</th>
    <th>Toner Low</th>
    <th>Toner Out</th>
    <th>Waste Warn</th>
    <th>Waste Full</th>
    <th>Service</th>
    <th>Maintenance</th>
  </tr>
  <% @devices_by_name.each do |d| %>
  <%   
    key = "#{d.name}|#{d.model}|#{d.serial}"
    days = @first_alert[key].nil? ? nil : (DateTime.now - @first_alert[key].created_at.to_datetime).to_f
  %>
  <tr class="<%= cycle('light','dark') -%>">
    <td><%= link_to h(d.name), alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&commit=Find", :title => "#{d.model}, #{d.serial}, #{d.code}" -%> (<%= d.client.nil? ? link_to("<Edit Device Info>", edit_device_path(d)) : d.client.name %>)</td>
    <td class='right-justify'><%= days.nil? ? 0 : days.round(1) %> days</td>
    <td class='right-justify'>
      <% if @misfeed[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @misfeed[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=misfeed&commit=Find", :title => @misfeed[key].empty? ? '' : "Last misfeed: #{@misfeed[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@misfeed[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @paper[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @paper[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=paper&commit=Find", :title => @paper[key].empty? ? '' : "Last Paper Out: #{@paper[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@paper[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @toner_low[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @toner_low[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=toner supply&commit=Find", :title => @toner_low[key].empty? ? '' : "Last Low Toner: #{@toner_low[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@toner_low[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @toner_out[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @toner_out[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=add toner&commit=Find", :title => @toner_out[key].empty? ? '' : "Last Toner Empty: #{@toner_out[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@toner_out[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @waste_warn[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @waste_warn[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=replacement&commit=Find", :title => @waste_warn[key].empty? ? '' : "Last Waste Container Warning: #{@waste_warn[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@waste_warn[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @waste_full[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @waste_full[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=replace used toner&commit=Find", :title => @waste_full[key].empty? ? '' : "Last Waste Container Full: #{@waste_full[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@waste_full[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @service[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @service[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=service&commit=Find", :title => @service[key].empty? ? '' : "Last Call for Service: #{@service[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@service[key].length / days).round(1) %>)
      <% end %>
    </td>
    <td class='right-justify'>
      <% if @maint[key].empty? %>
        0 (0.0)
      <% else %>
        <%= link_to @maint[key].length, alerts_path + "?model_q=#{d.model}&serial_q=#{d.serial}&msg_q=maintenance&commit=Find", :title => @maint[key].empty? ? '' : "Last Maint. Req.: #{@maint[key].last.alert_date.to_formatted_s(:db)}" -%> (<%= (@maint[key].length / days).round(1) %>)
      <% end %>
    </td>
  </tr>
  <% end %>
</table>

<br />
<table class="list">
  <tr>
    <th colspan=9>Alerts by Model - Number in parenthesis is number of alerts per device</th>
  </tr>
  <tr>
    <th>Model</th>
    <th>Misfeed</th>
    <th>Paper Out</th>
    <th>Toner Low</th>
    <th>Toner Out</th>
    <th>Waste Warn</th>
    <th>Waste Full</th>
    <th>Service</th>
    <th>Maintenance</th>
  </tr>
  <% @devices_by_model.each do |d| %>
  <%   dev_count = @count_by_model[d.model] %>
  <tr class="<%= cycle('light','dark') -%>">
    <td>
      <%= link_to h(d.model), alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&commit=Find", :title => "Click to view all alerts for this model" -%> (<%= dev_count -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @misfeed[d.model].empty?, @misfeed[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=misfeed&commit=Find", :title => @misfeed[d.model].empty? ? '' : "#{@misfeed[d.model].last.alert_date.to_formatted_s(:db)} from #{@misfeed[d.model].last.name}" -%> (<%= (@misfeed[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @paper[d.model].empty?, @paper[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=paper&commit=Find", :title => @paper[d.model].empty? ? '' : "#{@paper[d.model].last.alert_date.to_formatted_s(:db)} from #{@paper[d.model].last.name}" -%> (<%= (@paper[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @toner_low[d.model].empty?, @toner_low[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=toner supply&commit=Find", :title => @toner_low[d.model].empty? ? '' : "#{@toner_low[d.model].last.alert_date.to_formatted_s(:db)} from #{@toner_low[d.model].last.name}" -%> (<%= (@toner_low[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @toner_out[d.model].empty?, @toner_out[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=add toner&commit=Find", :title => @toner_out[d.model].empty? ? '' : "#{@toner_out[d.model].last.alert_date.to_formatted_s(:db)} from #{@toner_out[d.model].last.name}" -%> (<%= (@toner_out[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @waste_warn[d.model].empty?, @waste_warn[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=replacement&commit=Find", :title => @waste_warn[d.model].empty? ? '' : "#{@waste_warn[d.model].last.alert_date.to_formatted_s(:db)} from #{@waste_warn[d.model].last.name}" -%> (<%= (@waste_warn[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @waste_full[d.model].empty?, @waste_full[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=replace used toner&commit=Find", :title => @waste_full[d.model].empty? ? '' : "#{@waste_full[d.model].last.alert_date.to_formatted_s(:db)} from #{@waste_full[d.model].last.name}" -%> (<%= (@waste_full[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @service[d.model].empty?, @service[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=service&commit=Find", :title => @service[d.model].empty? ? '' : "#{@service[d.model].last.alert_date.to_formatted_s(:db)} from #{@service[d.model].last.name}" -%> (<%= (@service[d.model].length.to_f / dev_count).round(1) -%>)</td>
    <td class='right-justify'>
      <%= link_to_unless @maint[d.model].empty?, @maint[d.model].length, alerts_path + "?model_q=#{d.model}&client_q=#{@client_q}&msg_q=maintenance&commit=Find", :title => @maint[d.model].empty? ? '' : "#{@maint[d.model].last.alert_date.to_formatted_s(:db)} from #{@maint[d.model].last.name}" -%> (<%= (@maint[d.model].length.to_f / dev_count).round(1) -%>)</td>
  </tr>
<% end %>
</table> 

<% end %>